# dbo-simulation

### Overview

DBO (Delivery Based Ordering) is a novel mechanism that guarantees fairness by post-hoc offsetting the latency differences among market participants in the cloud. This repository contains the simulation framework for DBO using real cloud traces collected over Azure, which includes:

1. A simulation framework for Financial Exchanges which can be extended to simulate various algorithms and evaluate their performance based on latency and fairness achieved.
2. A real 15 min cloud trace on Azure using 10 MPs. The RBs and MPs are implemented as independent processes on same VMs.
3. Scripts to reproduce the simulation results from our paper, **DBO: Fairness for Cloud-Hosted Financial Exchanges**, published at *SIGCOMM'23*. Please see our paper for more details about the architecture and schemes: [https://dl.acm.org/doi/10.1145/3603269.3604871](https://dl.acm.org/doi/10.1145/3603269.3604871)

## Organization

The repository is organized as follows:

- `algorithms` contains the various algorithms simulated in our framework:
    - `algorithm.py` defines the base class with methods to be defined by various algorithms.
    - `dbo.py` extends the base class to implement the DBO algorithm.
    - `cloudex.py` extends the base class to implement the Cloudex algorithm (see more details [here](https://doi.org/10.1145/3458336.3465278)).
    - `direct.py` extends the base class to implement direct delivery where the data and trades are transmitted without any delays the the RB or the OB.
    - `max_rtt.py` extends the `DBO` class to simulate the bounds for Response Time Fairness defined in Section 4.2.1 of the paper.
- `run_simulation.py` is used to run various simulations using the trace data `traces/direct.zip`. The output for each algorithm is stored to `traces/simulation.dat`.
- `traces` should contain the cloud trace and
    - `simulation.dat` contains the output from various simulation runs using `run_simulation.py`.
    - `trace_indices.py` contains the constants used for simulation.
- `plot_figures.py` uses the outputs of various runs from `traces/simulation.dat` to plot the graphs and figures.
- `figures` stores the figures generated by various scripts.
- `util.py` contains various functions used to generate random RTT traces or to read and format traces from the trace files.

## Running Simulations

To run simulations using the cloud trace, first download the trace file `direct.zip` from the release page of v1: [https://github.com/eash3010/dbo-simulation/releases/tag/v1](https://github.com/eash3010/dbo-simulation/releases/tag/v1) and place it in the `traces/` directory. For more details about the cloud trace, please refer to the next [subsection](#cloud-trace).

Now:

```
python3 run_simulation.py
```

This will generate the `traces/simulation.dat` file which is of the format:

```
<algorithm title and parameters>,<number of participants>,<fairness ratio>,<mean latency>,<99p latency>,<maximum latency>
```

Example:

```
DBO(20|25|0),10,0.9998977777777779,51.72777250220907,130.02876502950676,439.73724861914525
MaxRTT,10,0.9987654888888892,31.127322084931084,46.65426705230493,406.3654986593174
DBO(20|25|0),20,0.9998023684210525,54.7128038365994,215.74071731895674,452.1485372555908
Cloudex(15|15),10,0.9951819555555554,30.181985499269878,31.61907858124118,400.4027382090717
Cloudex(20|20),10,0.9988185999999999,40.12518497419023,40.0,400.4027382090717
...
```

### Plotting figures from the paper

The outputs from `traces/simulation.dat` can be used by `plot_figures.py` to generate figures in the `figures/` directory.
```
python3 plot_figures.py
```

### Cloud trace

The cloud trace can be downloaded from release page: [https://github.com/eash3010/dbo-simulation/releases/tag/v1](https://github.com/eash3010/dbo-simulation/releases/tag/v1). The cloud trace is a pandas dataframe which has one row for each trade generated by each MP. It can be read in python using:
```
import pandas
cloud_trace = pandas.read_csv("traces/direct.zip")
```

The columns in the dataframe are as follows:

| **Column name** | **Defination** |
|-----------------|----------------|
| data_id | ID of data point to which this trade was a response. |
| generation_time | Timestamp at generation of data point at the CES in &mu;s. |
| mp_id | The MP ID which sent the trade. |
| response_time | Time taken by MP to respond. |
| pacing_delay | Time taken by RB before it is sent to MP. |
| execution_time | Timestamp of trade execution at the CES in &mu;s. |
| ces_recv_time | Timestamp when OB receives the trade from the MP in &mu;s. |


All times are measured in &mu;s.

## Testing custom algorithms

Various algorithms for a financial exchange that follow the same architecture as Figure 1 (from the paper) can be implemented by defining the delivery algorithm at the RB and the ordering algorithm at the OB. See how `DBO` is implemented in `algorithms/dbo.py` to extend the `Algorithm` class for more details.

## Authors

- Prateesh Goyal
- Eashan Gupta

## Citation

Please cite our paper if you find our code useful.

```
@inproceedings{10.1145/3603269.3604871,
author = {Gupta, Eashan and Goyal, Prateesh and Marinos, Ilias and Zhao, Chenxingyu and Mittal, Radhika and Chandra, Ranveer},
title = {DBO: Fairness for Cloud-Hosted Financial Exchanges},
year = {2023},
isbn = {9798400702365},
publisher = {Association for Computing Machinery},
address = {New York, NY, USA},
url = {https://doi.org/10.1145/3603269.3604871},
doi = {10.1145/3603269.3604871},
booktitle = {Proceedings of the ACM SIGCOMM 2023 Conference},
pages = {550â€“563},
numpages = {14},
keywords = {cloud, high frequency trading, financial exchange, fairness, logical clock},
location = {New York, NY, USA},
series = {ACM SIGCOMM '23}
}
```
